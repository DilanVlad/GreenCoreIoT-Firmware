#include <WiFi.h>
#include <HTTPClient.h>
#include <DHT.h>

// ================== CONFIGURACIÓN WIFI ==================
const char* ssid = "INNO-";
const char* password = "pass";

// ================== ENDPOINT ==================
const char* serverUrl = "https://bq1skqgh-7278.use2.devtunnels.ms/api/Lecturas";

// ================== SLOTS ==================
#define SLOT_1 1   // MES-001 (TRIGO)
#define SLOT_2 2   // MES-002 (AVENA)

// ================== PINES SLOT 1 ==================
#define DHTPIN_1 27
#define SOIL_PIN_1 34
#define LDR_PIN_1 35

// ================== HARDWARE ==================
#define DHTTYPE DHT11
DHT dht1(DHTPIN_1, DHTTYPE);

// ======================================================

void setup() {
  Serial.begin(115200);
  dht1.begin();

  // Semilla para valores aleatorios
  randomSeed(analogRead(0));

  // Conexión WiFi
  WiFi.begin(ssid, password);
  Serial.print("Conectando WiFi");
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }

  Serial.println("\nWiFi conectado");
  Serial.print("IP: ");
  Serial.println(WiFi.localIP());
}

// ======================================================

void loop() {

  // ==========================================
  // ===== SLOT 1 (MES-001 / TRIGO) ===========
  // ==========================================
  float temp1 = dht1.readTemperature();
  float humAmb1 = dht1.readHumidity();

  if (!isnan(temp1) && !isnan(humAmb1)) {

    int rawSoil1 = analogRead(SOIL_PIN_1);
    int humSoil1 = map(rawSoil1, 4095, 1600, 0, 100);
    humSoil1 = constrain(humSoil1, 0, 100);

    int rawLdr1 = analogRead(LDR_PIN_1);
    int luz1 = map(rawLdr1, 4095, 200, 0, 10000);
    luz1 = constrain(luz1, 0, 10000);

    float humCan1 = humAmb1 + 2.0;

    enviarLectura(SLOT_1, "TEMP", temp1);
    enviarLectura(SLOT_1, "HUMA", humAmb1);
    enviarLectura(SLOT_1, "HUMS", humSoil1);
    enviarLectura(SLOT_1, "LUX", luz1);
    enviarLectura(SLOT_1, "HUMC", humCan1);

  } else {
    Serial.println(" Error leyendo DHT11 en Slot 1");
  }

  // ==========================================
  // ===== SLOT 2 (MES-002 / AVENA) ===========
  // ===== DATOS ALEATORIOS CON RANGOS =======
  // ==========================================

  float temp2   = random(50, 280) / 10.0;   // 5 – 28 °C

  
  float humAmb2;
  int probAlerta = random(0, 100); // 0–99
  
  if (probAlerta < 20) {
    // 20% del tiempo FUERA de rango
    if (random(0, 2) == 0) {
      humAmb2 = random(150, 390) / 10.0; // 15 – 39 %
    } else {
      humAmb2 = random(910, 980) / 10.0; // 91 – 98 %
    }
  } else {
    // 80% del tiempo DENTRO de rango
    humAmb2 = random(400, 900) / 10.0;   // 40 – 90 %
  }



  float humSoil2 = random(30, 90);           // 30 – 90 %
  float humCan2 = random(400, 900) / 10.0;  // 40 – 90 %
  float luz2    = random(200, 9000);         // Lux (sin rango definido)

  enviarLectura(SLOT_2, "TEMP", temp2);
  enviarLectura(SLOT_2, "HUMA", humAmb2);
  enviarLectura(SLOT_2, "HUMS", humSoil2);
  enviarLectura(SLOT_2, "LUX", luz2);
  enviarLectura(SLOT_2, "HUMC", humCan2);

  Serial.println("------------------------------------------------");
  delay(10000);
}

// ======================================================

void enviarLectura(int slot, String idVar, float valor) {

  if (WiFi.status() != WL_CONNECTED) {
    Serial.println(" WiFi desconectado");
    return;
  }

  HTTPClient http;
  http.begin(serverUrl);
  http.addHeader("Content-Type", "application/json");

  String json = "{";
  json += "\"slot\":" + String(slot) + ",";
  json += "\"idVar\":\"" + idVar + "\",";
  json += "\"valorLec\":" + String(valor, 2);
  json += "}";

  Serial.print(" Enviando [Slot ");
  Serial.print(slot);
  Serial.print(" - ");
  Serial.print(idVar);
  Serial.print("]: ");

  int httpCode = http.POST(json);

  if (httpCode > 0) {
    Serial.printf("OK (HTTP %d)\n", httpCode);
  } else {
    Serial.printf("ERROR: %s\n", http.errorToString(httpCode).c_str());
  }

  http.end();
}
